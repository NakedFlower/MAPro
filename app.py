from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List, Dict, Any
import os
from sqlalchemy import create_engine, text
from sqlalchemy.engine import Engine
from dotenv import load_dotenv
import re
import requests

# ------------------ ì§€ì—­ëª… ì²˜ë¦¬ í´ë˜ìŠ¤ ------------------
class LocationService:
    def __init__(self):
        self.api_key = os.getenv("MOIS_API_KEY", "devU01TX0FVVEgyMDI1MDkxMjExMzczMjExNjE3ODE=")
        self.api_url = "https://business.juso.go.kr/addrlink/addrLinkApi.do"

    def _call_mois_api(self, keyword: str, max_results: int = 20, timeout_sec: float = 0.7) -> list:
        if not keyword or not self.api_key:
            return []
        params = {
            "confmKey": self.api_key,
            "resultType": "json",
            "currentPage": "1",
            "countPerPage": str(max_results),
            "keyword": keyword,
        }
        try:
            resp = requests.get(self.api_url, params=params, timeout=timeout_sec)
            if resp.status_code != 200:
                return []
            data = resp.json() if resp.content else None
            return ((data or {}).get("results") or {}).get("juso") or []
        except Exception:
            return []

    def _parse_region_from_address(self, addr: str) -> Optional[str]:
        if not addr:
            return None
        tokens = addr.strip().split()
        if not tokens:
            return None
        def is_region_token(tok: str) -> bool:
            return tok.endswith(("ì‹œ", "êµ°", "êµ¬"))
        region_tokens = [t for t in tokens[:5] if is_region_token(t)]
        if not region_tokens:
            sub_tokens = [t for t in tokens[:5] if t.endswith(("ë™", "ì", "ë©´"))]
            return sub_tokens[0] if sub_tokens else None
        def simplify(tok: str) -> str:
            return tok.replace("íŠ¹ë³„ì‹œ", "").replace("ê´‘ì—­ì‹œ", "").replace("ìì¹˜êµ¬", "").strip()
        simplified = [simplify(t) for t in region_tokens[:2]]
        return " ".join([t for t in simplified if t]) or None

    def _generate_location_candidates(self, text: str) -> list:
        if not text:
            return []
        candidates = []
        seen = set()
        def push(s: str):
            key = s.strip()
            if key and key not in seen:
                seen.add(key)
                candidates.append(key)
        push(text)
        tokens = text.split()
        admin_suffixes = ("ì‹œ", "êµ°", "êµ¬", "ë™", "ì", "ë©´")
        trial_suffixes = ("êµ¬", "ì‹œ", "êµ°")
        for tok in tokens:
            if not tok:
                continue
            if tok.endswith(admin_suffixes):
                push(tok)
                continue
            for suf in trial_suffixes:
                push(f"{tok}{suf}")
                push(text.replace(tok, f"{tok}{suf}", 1))
        return candidates

    def get_location_candidates(self, text: str, timeout_sec: float = 0.7) -> list:
        candidates = []
        seen = set()
        for keyword in self._generate_location_candidates(text):
            juso_list = self._call_mois_api(keyword, timeout_sec=timeout_sec)
            for juso in juso_list:
                addr = juso.get("roadAddr") or juso.get("jibunAddr") or ""
                region = self._parse_region_from_address(addr)
                tokens = addr.split()
                dong = next((t for t in tokens if t.endswith(("ë™", "ì", "ë©´"))), None)
                if region:
                    label = f"{region} {dong}".strip() if dong and dong not in region else region
                    if label and label not in seen:
                        seen.add(label)
                        candidates.append(label)
        return candidates[:5]

    def resolve_single_location(self, text: str, timeout_sec: float = 0.7) -> Optional[str]:
        candidates = self.get_location_candidates(text, timeout_sec)
        return candidates[0] if len(candidates) == 1 else None

# ì§€ì—­ ì²˜ë¦¬ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
location_service = LocationService()

# ------------------ ë¶„ë¥˜/í‚¤ì›Œë“œ ì‚¬ì „ ------------------
# ì¹´í…Œê³ ë¦¬ ë§¤í•‘
CATEGORY_PHRASES = {
    "ìŒì‹ì ": ["ìŒì‹ì ", "ì‹ë‹¹", "ë ˆìŠ¤í† ë‘", "ë¨¹ì„ë°", "ë¨¹ì„ ê³³", "ë°¥ì§‘", "ë§›ì§‘"],
    "ì¹´í˜": ["ì¹´í˜", "ì»¤í”¼ìˆ", "ì»¤í”¼ ìˆ", "ë‹¤ë°©", "ì¹´í˜í…Œë¦¬ì•„", "ì¹´í˜ë¼ìš´ì§€"],
    "í¸ì˜ì ": ["í¸ì˜ì ", "í¸ì˜ ë§ˆíŠ¸", "ìƒì "],
    "ì•½êµ­": ["ì•½êµ­"],
    "í˜¸í…”": ["í˜¸í…”", "ìˆ™ì†Œ", "ìˆ™ë°•", "ë ˆì§€ë˜ìŠ¤", "ë¦¬ì¡°íŠ¸"],
    "í—¤ì–´ìƒµ": ["í—¤ì–´ìƒµ", "ë¯¸ìš©ì‹¤", "í—¤ì–´ ì‚´ë¡±", "í—¤ì–´ì‚´ë¡±", "ì‚´ë¡±","ë°”ë²„ìƒµ", "ì´ë°œì†Œ"],
    "ë³‘ì›": ["ë³‘ì›", "ì˜ì›", "í´ë¦¬ë‹‰", "ë©”ë””ì»¬"]
}

# 1. í‚¤ì›Œë“œ-í‘œí˜„ ì‚¬ì „ ì •ì˜
KEYWORD_DICT = {
    "ìŒì‹ì ": {
        "ìœ ì•„ì˜ì": {
            "positive": [
                "ìœ ì•„", "ì•„ê¸°", "í•˜ì´ ì²´ì–´", "ë² ì´ë¹„ ì²´ì–´", "í‚¤ì¦ˆ", "ì–´ë¦°ì´", "ì•„ì´", "ì•„ê°€", "ì• ê¸°",
                "ìœ ëª¨ì°¨", "ë² ì´ë¹„ ì¹´", "ìœ¡ì•„ ë§˜", "ì• ê¸° ì—„ë§ˆ", "ì—„ë§ˆ", "ë§˜", "ëª¨ìœ ", "ìˆ˜ìœ ", "ê¸°ì €ê·€",
                "ìœ ì•„ì°¨", "ì¹´ì‹œíŠ¸", "ë¶ì²´ì–´", "ì•„ê¸°ì˜ì", "ì–´ë¦°ì´ì˜ì", "í‚¤ì¦ˆì²´ì–´", "í•˜ì´ì²´ì–´",
                "ì˜ìœ ì•„", "ì‹ ìƒì•„", "ê±¸ìŒë§ˆ", "í† ë“¤ëŸ¬", "ì–´ë¨¸ë‹ˆ", "ë¶€ëª¨", "ê°€ì¡±ë‹¨ìœ„", "íŒ¨ë°€ë¦¬",
                "ì• ë“¤", "ê¼¬ë§ˆ", "ê¼¬ë§¹ì´", "ì• ê¸°ë“¤", "ì•„ì´ë“¤", "ì†Œì•„", "ë¯¸ì·¨í•™", "ìœ ì¹˜ì›",
                "ì„ì‹ ë¶€", "ì„ì‚°ë¶€", "ì¶œì‚°", "ìœ¡ì•„", "ìë…€", "ë”¸", "ì•„ë“¤", "ì²«ì§¸", "ë‘˜ì§¸",
                "ìŒë‘¥ì´", "ë‹¤ë‘¥ì´", "ì›Œí‚¹ë§˜", "ìœ¡ì•„ë§˜", "ì‹ í˜¼ë¶€ë¶€"
            ],
            "negative": [
                "ìœ ì•„ ì˜ì ì—†ë‹¤", "ì•„ê¸° ì˜ì ì—†ë‹¤", "í•˜ì´ ì²´ì–´ ì—†ë‹¤", "ë² ì´ë¹„ ì²´ì–´ ì—†ë‹¤",
                "ì•„ì´ ì•‰íˆë‹¤ ê³³ ì—†ë‹¤", "í‚¤ì¦ˆ ì˜ì ì—†ë‹¤", "ì•„ì´ ë°ë¦¬ ê³  ê°€ê¸° í˜ë“¤ë‹¤"
            ]
        },
        "í˜¼ë°¥": {
            "positive": [
                "í˜¼ë°¥", "1ì¸", "ì†”ë¡œ", "í˜¼ì", "ì¹´ìš´í„° ì„", "ë°” í…Œì´ë¸”", "í™€ë¡œ", "ë‚˜í™€ë¡œ",
                "ê°œì¸", "ë‹¨ë…", "1ì¸ì„", "ë°”ì„", "ì¹´ìš´í„°", "í˜¼ìì„œ", "í˜¼ìë§Œ", "í™€ëª¸",
                "ì›ë§¨", "1ì¸ìš©", "ì‹±ê¸€", "ê°œë³„", "í˜¼í–‰", "í˜¼ì ì‹ì‚¬", "1ì¸ ì‹ì‚¬",
                "ê°œì¸ ì‹ì‚¬", "ì†”ë¡œ ì‹ì‚¬", "í˜¼ë°¥ì¡±", "í˜¼ë°¥ëŸ¬", "ë‚˜ í˜¼ì", "ì™¸ë¡œìš´",
                "í˜¼ì ì˜¤ë‹¤", "í˜¼ì ë°©ë¬¸", "1ì¸ ë°©ë¬¸", "ê°œì¸ ë°©ë¬¸", "ì†”ë¡œ ë°©ë¬¸"
            ],
            "negative": [
                "í˜¼ë°¥ ë¶ˆê°€", "1 ì¸ ì•ˆë¨", "í˜¼ì ì˜¤ê¸° ì–´ë µë‹¤", "1 ì¸ì„ ì—†ë‹¤",
                "2 ì¸ ì´ìƒ", "ë‹¨ì²´ ì „ìš©", "ì»¤í”Œ ì „ìš©", "ê°€ì¡± ì „ìš©"
            ]
        },
        "ìƒˆë¡œì˜¤í”ˆ": {
            "positive": [
                "ìƒˆë¡­ë‹¤", "ì‹ ê·œ", "ì˜¤í”ˆ", "ê·¸ëœë“œ", "ë¦¬ë‰´ì–¼", "ì‹ ìƒ", "ë‰´", "ì‹ ì„ ",
                "ìµœê·¼", "ê°“", "ë§‰", "ë”°ëˆë”°ëˆ", "ì‹ ìƒ", "ê¹¨ë—", "ë§ë”", "ìƒˆë¡œ", "ì‹ ì§„",
                "ìƒˆë‹¨ì¥", "ìƒˆë¡œ ìƒê¸´", "ìƒˆë¡œ ë¬¸ ì—´ë‹¤", "ìƒˆë¡œ ê°œì—…", "ê°œì—…", "ê°œì ",
                "ì‹ ê·œ ì˜¤í”ˆ", "ê·¸ëœë“œ ì˜¤í”ˆ", "ì†Œí”„íŠ¸ ì˜¤í”ˆ", "í”„ë¦¬ ì˜¤í”ˆ", "ë² íƒ€ ì˜¤í”ˆ",
                "ë¦¬ì˜¤í”ˆ", "ì¬ì˜¤í”ˆ", "ì¬ê°œì—…", "ì¬ê°œì ", "ìƒˆë‹¨ì¥ ì˜¤í”ˆ", "ìƒˆë¡œì›Œì§„",
                "ìƒˆë¡œ ë°”ë€", "ìƒˆë¡œ ë‹¨ì¥", "ìƒˆë¡­ê²Œ", "ê°œì„ ", "ì—…ê·¸ë ˆì´ë“œ", "ì‹ ì¶•",
                "ì‹ ì„¤", "ì‹ ìƒ", "ë”°ëˆ", "ë§‰ ì˜¤í”ˆ", "ê°“ ì˜¤í”ˆ", "ë°©ê¸ˆ ì—´ë‹¤"
            ],
            "negative": [
                "ì˜¤ë˜ëœ", "ì „í†µ", "ì—­ì‚¬", "ì›ì¡°", "ë³¸ì ", "ë…¸í¬", "ìˆ˜ì‹­ ë…„"
            ]
        },
        "ë°ì´íŠ¸": {
            "positive": [
                "ë°ì´íŠ¸", "ì—°ì¸", "ì»¤í”Œ", "ì• ì¸", "ë¶„ìœ„ê¸°", "ë¬´ë“œ", "ë¡œë§¨í‹±", "ë¡œë§¨ìŠ¤",
                "ì€ì€í•œ ì¡°ëª…", "ê°„ì ‘ ì¡°ëª…", "ìº”ë“¤", "ê¸°ë…ì¼", "í”„ëŸ¬í¬ì¦ˆ", "í”„ë¡œí¬ì¦ˆ",
                "í™í•œ", "ê°ì„±", "ê°¬ì„±", "ë·°", "ì•¼ê²½", "í…Œë¼ìŠ¤", "ë£¨í”„íƒ‘", "ì˜¥ìƒ",
                "ì—°ì• ", "ì¸", "ì¸íƒ€ë‹¤", "ë°€ë‹¹", "ì†Œê°œíŒ…", "ë¯¸íŒ…", "ë§Œë‚¨", "ì²«ë§Œë‚¨",
                "ê¸°ë…", "ë°œë Œíƒ€ì¸", "í™”ì´íŠ¸ë°ì´", "ìƒì¼", "100ì¼", "200ì¼", "1ì£¼ë…„",
                "ê²°í˜¼ê¸°ë…ì¼", "íŠ¹ë³„í•œ ë‚ ", "ì´ë²¤íŠ¸", "ì„œí”„ë¼ì´ì¦ˆ", "ê¹œì§", "ì´ìƒ‰",
                "ë¡œë§¨í‹±í•œ", "ë‹¬ë‹¬í•œ", "ì„¤ë ˜", "ì‹¬ì¿µ", "ì„¤ë ˆëŠ”", "ë‘ê·¼ë‘ê·¼", "ëŠë‚Œ",
                "ë¶„ìœ„ê¸° ìˆëŠ”", "ë¬´ë“œ ìˆëŠ”", "ê³ ê¸‰ì§„", "ì„¸ë ¨ëœ", "ê°ê°ì ", "ì˜ˆìœ",
                "ì´ìœ", "ì•„ë¦„ë‹¤ìš´", "ë©‹ì§„", "ê·¼ì‚¬í•œ", "ë¶„ìœ„ê¸° ì¢‹ì€", "ë·° ë§›ì§‘",
                "ì•¼ê²½ ë§›ì§‘", "ë°ì´íŠ¸ ì½”ìŠ¤", "ì—°ì¸ ì½”ìŠ¤", "ì»¤í”Œ ì½”ìŠ¤", "ë¶„ìœ„ê¸° ë§›ì§‘"
            ],
            "negative": [
                "ë°ì´íŠ¸ ë¹„ì¶”", "ë¶„ìœ„ê¸° ë³„ë¡œ", "ë¬´ë“œ ì—†ë‹¤", "ì‹œë„ëŸ½ë‹¤",
                "í˜•ê´‘ë“±", "ë°ì´íŠ¸ ë¶„ìœ„ê¸° ì•„ë‹ˆë‹¤"
            ]
        },
        "ë…¸í‚¤ì¦ˆì¡´": {
            "positive": [
                "ë…¸í‚¤ì¦ˆ", "ì„±ì¸ ì „ìš©", "ì–´ë¥¸ ì „ìš©", "19 ì„¸ ì´ìƒ", "ì¶œì… ê¸ˆì§€",
                "ì„±ì¸ë§Œ", "ì–´ë¥¸ë§Œ", "ë¯¸ì„±ë…„ì ê¸ˆì§€",
                "ì•„ë™ ì¶œì… ê¸ˆì§€", "í‚¤ì¦ˆ ì¶œì… ê¸ˆì§€", "ì–´ë¦°ì´ ì¶œì… ê¸ˆì§€", "ìœ ì•„ ì¶œì… ê¸ˆì§€",
                "ì¡°ìš©í•œ", "ì •ì ì¸", "ì°¨ë¶„í•œ", "ì„±ì¸ ê³µê°„", "ì–´ë¥¸ ê³µê°„", "ì •ìˆ™",
                "ë¯¸ì„±ë…„ ì¶œì… ë¶ˆê°€", "ì•„ë™ ê¸ˆì§€", "í‚¤ì¦ˆ ê¸ˆì§€", "ì–´ë¦°ì´ ê¸ˆì§€"
            ],
            "negative": [
                "ì•„ì´ë“¤ ë§ë‹¤", "ì‹œë„ëŸ½ë‹¤ ì•„ì´ë“¤", "ë…¸í‚¤ì¦ˆì¡´ ì•„ë‹ˆë‹¤",
                "í‚¤ì¦ˆ ì¹´í˜", "í‚¤ì¦ˆ í”„ë Œë“¤ë¦¬"
            ]
        },
        "ì§€ì—­í™”í": {
            "positive": [
                "ì§€ì—­ í™”í", "ì§€ì—­ ìƒí’ˆê¶Œ", "ìƒí’ˆê¶Œ", "ì§€ì—­ í˜ì´", "ì‹œë¯¼ í˜ì´",
                "QRì½”ë“œ", "QR ê²°ì œ", "ë°”ì½”ë“œ", "ë°”ì½”ë“œ ê²°ì œ", "ì•± ê²°ì œ", "í•¸ë“œí° ê²°ì œ",
                "ë””ì§€í„¸ í™”í", "ì „ì í™”í", "ì „ì ìƒí’ˆê¶Œ", "ë””ì§€í„¸ ìƒí’ˆê¶Œ",
                "í˜ì´", "pay", "wallet", "ì›”ë ›", "ê°„í¸í˜ì´", "ì›í„°ì¹˜", "í„°ì¹˜ê²°ì œ"
            ],
            "negative": [
                "ì§€ì—­ í™”í ì•ˆë¨", "ìƒí’ˆê¶Œ ì‚¬ìš© ë¶ˆê°€", "í˜ì´ ì•ˆë¨",
                "í˜„ê¸ˆë§Œ", "ì¹´ë“œë§Œ"
            ]
        },
        "ì£¼ì°¨": {
            "positive": [
                "ì£¼ì°¨", "íŒŒí‚¹", "ë¬´ë£Œ ì£¼ì°¨", "ë°œë ›", "ì£¼ì°¨ì¥",
                "ì£¼ì°¨ ë©´", "ì£¼ì°¨ ìë¦¬", "ì£¼ì°¨ ì¹¸", "ì£¼ì°¨ê³µê°„", "ì£¼ì°¨ì‹œì„¤",
                "ë¬´ë£ŒíŒŒí‚¹", "ë°œë ›íŒŒí‚¹", "ì…€í”„íŒŒí‚¹", "ì§€ìƒì£¼ì°¨", "ì§€í•˜ì£¼ì°¨",
                "ì˜¥ì™¸ì£¼ì°¨", "ì‹¤ë‚´ì£¼ì°¨", "ì£¼ì°¨íƒ€ì›Œ", "ê¸°ê³„ì‹ì£¼ì°¨", "í‰ë©´ì£¼ì°¨",
                "ì£¼ì°¨ìš”ê¸ˆ", "ì£¼ì°¨ë¹„", "ì£¼ì°¨í• ì¸", "ì£¼ì°¨ë¬´ë£Œ", "ì£¼ì°¨ê°€ëŠ¥",
                "ì£¼ì°¨í¸ë¦¬", "ì£¼ì°¨ì—¬ìœ ", "ì£¼ì°¨ë„“ë‹¤", "ì°¨ ì„¸ìš°ê¸°", "ì°¨ ëŒˆ ê³³",
                "ì°¨ëŸ‰", "ìë™ì°¨", "ì°¨", "ìŠ¹ìš©ì°¨", "SUV", "íŠ¸ëŸ­", "ë°´"
            ],
            "negative": [
                "ì£¼ì°¨ ì–´ë µë‹¤", "ì£¼ì°¨ì¥ ì—†ë‹¤", "ì£¼ì°¨ í˜ë“¤ë‹¤", "ì£¼ì°¨ ë¶ˆê°€",
                "ì£¼ì°¨ ë‚œ", "ì£¼ì°¨ë¹„ ë¹„ì‹¸ë‹¤"
            ]
        },
        "ì¸ê¸°ë§ì€": {
            "positive": [
                "ì¸ê¸°", "í•«í•œ", "í•«í”Œ", "ìœ ëª…", "ì›¨ì´íŒ…", "ëŒ€ê¸°", "ì¤„ì„œê¸°", "ì¤„ì„œë‹¤",
                "ì˜ˆì•½ í•„ìˆ˜", "ì˜ˆì•½ ì–´ë µë‹¤", "ë¶ë¹„ëŠ”", "ë§›ì§‘", "SNS", "ì¸ìŠ¤íƒ€", "ë¸”ë¡œê·¸",
                "TV ë‚˜ì˜¨", "ì—°ì˜ˆì¸", "ì¬ë°©ë¬¸", "ë‹¨ê³¨", "ì†Œë¬¸ë‚œ", "ì…ì†Œë¬¸", "í™”ì œ",
                "ëŒ€ë°•", "í•«", "ëœ¨ëŠ”", "ëœ¨ë‹¤", "ëœ¨ê±°ìš´", "í™”ì œì˜", "ì¸ê¸° í­ë°œ",
                "ì¤„ ì„œëŠ”", "ëŒ€ê¸° ì‹œê°„", "ì›¨ì´íŒ… ì‹œê°„", "ì˜ˆì•½ ëŒ€ê¸°", "ì˜ˆì•½ ë°€ë¦¼",
                "ë§Œì„", "ëŒ€ê¸° ì¤„", "ì›¨ì´íŒ… ì¤„", "ì¸ì‚°ì¸í•´", "ë¶ì ë¶ì ",
                "ë°©ì†¡", "TV", "ë“œë¼ë§ˆ", "ì˜ˆëŠ¥", "ìœ íŠœë¸Œ", "í‹±í†¡", "ì¸í”Œë£¨ì–¸ì„œ",
                "ì…€ëŸ½", "ìŠ¤íƒ€", "ì•„ì´ëŒ", "ë°°ìš°", "ì—°ì˜ˆê³„", "ë°©ì†¡ì¸", "BJ",
                "ë¦¬ë·°", "í‰ì ", "ë³„ì ", "ì¶”ì²œ", "ê°•ì¶”", "ì¢‹ë‹¤", "ë§›ìˆë‹¤", "ìµœê³ ",
                "ê²€ì¦ëœ", "ì¸ì •ë°›ì€", "ì†Œì…œ", "ë°”ì´ëŸ´", "í•«ì´ìŠˆ", "ì´ìŠˆ"
            ],
            "negative": [
                "í•œì‚°í•œ", "ì›¨ì´íŒ… ì—†ë‹¤", "ì¸ê¸° ì—†ë‹¤", "ì•Œë ¤ì§€ì§€ ì•Šë‹¤"
            ]
        }
    },
    "ì¹´í˜": {
        "í¸í•œì¢Œì„": {
            "positive": [
                "í¸í•œ", "ì†ŒíŒŒ", "ì¿ ì…˜", "í‘¹ì‹ ", "ë„“ì€", "ì—¬ìœ ë¡œìš´", "ì•ˆë½", "í¸ì•ˆí•œ",
                "ì˜ì", "ì²´ì–´", "ì•”ì²´ì–´", "ë¼ìš´ì§€ì²´ì–´", "ë¦¬í´ë¼ì´ë„ˆ",
                "ì†ŒíŒŒì„", "ì¿ ì…˜ì„", "ì•ˆë½ì˜ì", "í¸ì•ˆí•œ ì˜ì", "í‘¹ì‹ í•œ ì˜ì",
                "ë„“ì€ ì˜ì", "ì—¬ìœ ë¡œìš´ ì¢Œì„", "ë¦´ë ‰ìŠ¤", "íœ´ì‹", "ì‰¬ê¸° ì¢‹ì€",
                "ì•‰ê¸° í¸í•œ", "ë“±ë°›ì´", "íŒ”ê±¸ì´", "ë°œë°›ì¹¨", "ì˜¤í† ë§Œ", "ë¹ˆë°±"
            ],
            "negative": [
                "ë¶ˆí¸", "ë”±ë”±í•œ", "ì¢ì€", "ë¹„ì¢ì€", "ì˜¤ë˜ ì•‰ê¸° í˜ë“¤ë‹¤"
            ]
        },
        "ì¹´ê³µ": {
            "positive": [
                "ì¹´ê³µ", "ê³µë¶€", "ìŠ¤í„°ë””", "ì‘ì—…", "ì—…ë¬´", "ë…¸íŠ¸ë¶",
                "ì™€ì´íŒŒì´", "ì½˜ì„¼íŠ¸", "ì „ì›", "ì¶©ì „", "ì¡°ìš©",
                "ì¹´í˜ ê³µë¶€", "ì¹´í˜ ì‘ì—…", "ìŠ¤í„°ë””ì¹´í˜", "ë¶ì¹´í˜", "ë„ì„œê´€",
                "ë…ì„œ", "ì±…", "êµì¬", "ì°¸ê³ ì„œ", "ë¬¸ì œì§‘", "í•„ê¸°", "ë©”ëª¨",
                "ì‹œí—˜", "ê³ ì‹œ", "ìê²©ì¦", "í† ìµ", "í† í”Œ", "ìˆ˜ëŠ¥", "ëŒ€ì…", "í¸ì…",
                "ê³¼ì œ", "ë ˆí¬íŠ¸", "ë…¼ë¬¸", "í”„ë¡œì íŠ¸", "íšŒì‚¬ì¼", "ì—…ë¬´ì²˜ë¦¬",
                "ì¬íƒê·¼ë¬´", "ì›ê²©ê·¼ë¬´", "í”„ë¦¬ëœì„œ", "ì°½ì—…", "ì‚¬ì—…", "ê¸°íš",
                "ì»´í“¨í„°", "íƒœë¸”ë¦¿", "ì•„ì´íŒ¨ë“œ", "ë§¥ë¶", "ë…¸íŠ¸ë¶", "pc",
                "ì¸í„°ë„·", "ì˜¨ë¼ì¸", "í´ë¼ìš°ë“œ", "êµ¬ê¸€", "ë„¤ì´ë²„", "ìœ íŠœë¸Œ",
                "ì „ì› ì½˜ì„¼íŠ¸", "ì¶©ì „ê¸°", "ì–´ëŒ‘í„°", "USB", "ë©€í‹°íƒ­"
            ],
            "negative": [
                "ì¹´ê³µ ë¶ˆê°€", "ê³µë¶€ ê¸ˆì§€", "ë…¸íŠ¸ë¶ ì‚¬ìš© ì œí•œ",
                "ì½˜ì„¼íŠ¸ ì—†ë‹¤", "ì™€ì´íŒŒì´ ì•½í•˜ë‹¤"
            ]
        },
        "ë…¸í‚¤ì¦ˆì¡´": {
            "positive": [
                "ë…¸í‚¤ì¦ˆ", "ì„±ì¸ ì „ìš©", "ì–´ë¥¸ ì „ìš©", "ì¶œì… ê¸ˆì§€",
                "ì„±ì¸ë§Œ", "ì–´ë¥¸ë§Œ", "ë¯¸ì„±ë…„ì ê¸ˆì§€", "19ì„¸ ì´ìƒ",
                "ì•„ë™ ì¶œì… ê¸ˆì§€", "í‚¤ì¦ˆ ì¶œì… ê¸ˆì§€", "ì–´ë¦°ì´ ì¶œì… ê¸ˆì§€", "ìœ ì•„ ì¶œì… ê¸ˆì§€",
                "ì¡°ìš©í•œ", "ì •ì ì¸", "ì°¨ë¶„í•œ", "ì„±ì¸ ê³µê°„", "ì–´ë¥¸ ê³µê°„", "ì •ìˆ™",
                "ë¯¸ì„±ë…„ ì¶œì… ë¶ˆê°€", "ì•„ë™ ê¸ˆì§€", "í‚¤ì¦ˆ ê¸ˆì§€", "ì–´ë¦°ì´ ê¸ˆì§€"
            ],
            "negative": [
                "ì•„ì´ë“¤ ë§ë‹¤", "ì‹œë„ëŸ½ë‹¤", "ë…¸í‚¤ì¦ˆì¡´ ì•„ë‹ˆë‹¤", "í‚¤ì¦ˆ ì¹´í˜"
            ]
        },
        "ë¶„ìœ„ê¸°ì¢‹ì€": {
            "positive": [
                "ë¶„ìœ„ê¸° ì¢‹ì€", "ë¬´ë“œ", "ê°ì„±", "ê°¬ì„±", "ë·°", "ì¡°ëª…", "ì¸í…Œë¦¬ì–´",
                "ì°½ê°€", "í…Œë¼ìŠ¤", "ìŒì•…", "bgm", "íë§",
                "ì˜ˆìœ", "ì´ìœ", "ì•„ë¦„ë‹¤ìš´", "ë©‹ì§„", "ê·¼ì‚¬í•œ", "ì„¸ë ¨ëœ", "ê°ê°ì ",
                "í’ê²½", "ê²½ì¹˜", "ì „ë§", "ì•¼ê²½", "ì¼ì¶œ", "ì¼ëª°", "ë…¸ì„", "ë°”ë‹¤",
                "ì‚°", "ê°•", "í˜¸ìˆ˜", "ê³µì›", "ìˆ²", "ë‚˜ë¬´", "ê½ƒ", "ì •ì›",
                "ë£¨í”„íƒ‘", "ì˜¥ìƒ", "ë°œì½”ë‹ˆ", "ë² ë€ë‹¤", "ì°½ë¬¸", "í†µì°½", "ì°½ë¬¸ê°€",
                "ìì—°ê´‘", "í–‡ì‚´", "í–‡ë¹›", "í–‡ì‚´ ì¢‹ì€", "ë°ì€", "í™˜í•œ",
                "ê°„ì ‘ì¡°ëª…", "ì€ì€í•œ ì¡°ëª…", "ë”°ëœ»í•œ ì¡°ëª…", "í¬ê·¼í•œ", "ì•„ëŠ‘í•œ",
                "ë¡œë§¨í‹±", "ë‚­ë§Œ", "ê°ì„±ì ", "ê°ì„± ì¹´í˜", "ê°¬ì„± ì¹´í˜", "í™í•œ"
            ],
            "negative": [
                "ë¶„ìœ„ê¸° ë³„ë¡œ", "ë¬´ë“œ ì—†ë‹¤", "ê°ì„± ì—†ë‹¤", "ë°‹ë°‹í•œ"
            ]
        },
        "ì¸í…Œë¦¬ì–´": {
            "positive": [
                "ì¸í…Œë¦¬ì–´", "ë””ìì¸", "ê¾¸ë°ˆ", "ê°ê°ì ", "ì„¸ë ¨ëœ", "ëª¨ë˜",
                "ë¹ˆí‹°ì§€", "ìœ ë‹ˆí¬", "ë…íŠ¹", "ì»¨ì…‰", "ë²½í™”", "ì•„íŠ¸",
                "ì¥ì‹", "ì†Œí’ˆ", "ê°€êµ¬", "í…Œì´ë¸”", "ì˜ì", "ì¡°ëª…", "ì‹ë¬¼", "í™”ë¶„",
                "ê·¸ë¦¼", "ì‚¬ì§„", "ì•¡ì", "í¬ìŠ¤í„°", "ìŠ¤í‹°ì»¤", "ë„¤ì˜¨ì‚¬ì¸", "ê°„íŒ",
                "ìƒ‰ê¹”", "ì»¬ëŸ¬", "í†¤", "íŒŒìŠ¤í…”", "ëª¨ë…¸í†¤", "ë¸”ë™ì•¤í™”ì´íŠ¸",
                "ìŠ¤íƒ€ì¼", "í…Œë§ˆ", "ì½˜ì…‰íŠ¸", "ì»¨ì…‰", "íŠ¸ë Œë“œ", "í™", "ê°ê°",
                "ë¯¸ë‹ˆë©€", "ì‹¬í”Œ", "í´ë˜ì‹", "ë ˆíŠ¸ë¡œ", "ì•ˆí‹±", "ëŸ¬ìŠ¤í‹±",
                "ì¸ë”ìŠ¤íŠ¸ë¦¬ì–¼", "ìŠ¤ì¹¸ë””", "ë¶ìœ ëŸ½", "í”„ë Œì¹˜", "ì•„ë©”ë¦¬ì¹¸"
            ],
            "negative": [
                "ì¸í…Œë¦¬ì–´ ë³„ë¡œ", "ê¾¸ë°ˆ ì—†ë‹¤", "ë‹¨ì¡°ë¡œìš´", "íŠ¹ìƒ‰ ì—†ë‹¤"
            ]
        },
        "ë””ì €íŠ¸": {
            "positive": [
                "ë””ì €íŠ¸", "ì¼€ì´í¬", "ë§ˆì¹´ë¡±", "ì¿ í‚¤", "íƒ€ë¥´íŠ¸", "ì™€í”Œ",
                "ë‹¬ì½¤", "ìˆ˜ì œ", "í™ˆë©”ì´ë“œ",
                "ë¹µ", "í¬ë¡œì•„ìƒ", "ìŠ¤ì½˜", "ë¨¸í•€", "ë„ë„›", "ë² ì´ê¸€", "ìƒŒë“œìœ„ì¹˜",
                "íŒŒì´", "í‘¸ë”©", "ì ¤ë¼í† ", "ì•„ì´ìŠ¤í¬ë¦¼", "ì†Œë¥´ë² ", "íŒŒë¥´í˜",
                "í‹°ë¼ë¯¸ìˆ˜", "ì¹˜ì¦ˆì¼€ì´í¬", "ì´ˆì½œë¦¿", "ì¹´ë¼ë©œ", "ë°”ë‹ë¼", "ë”¸ê¸°",
                "ë§›ìˆëŠ”", "ë‹¬ë‹¤", "ë‹¨ë§›", "ë‹¬ë‹¬í•œ", "ê¹”ë”í•œ", "ë¶€ë“œëŸ¬ìš´", "ì´‰ì´‰í•œ",
                "ë°”ì‚­í•œ", "ê³ ì†Œí•œ", "í–¥ê¸‹í•œ", "ì‹ ì„ í•œ", "í”„ë¦¬ë¯¸ì—„", "ê³ ê¸‰",
                "ë² ì´ì»¤ë¦¬", "ì œê³¼", "ì œë¹µ", "íŒ¨ìŠ¤íŠ¸ë¦¬", "ë¸ŒëŸ°ì¹˜", "ì• í”„í„°ëˆˆí‹°"
            ],
            "negative": [
                "ë””ì €íŠ¸ ë³„ë¡œ", "ì¼€ì´í¬ ì—†ë‹¤", "ë‹¬ì§€ ì•Šë‹¤", "ë§›ì—†ëŠ”"
            ]
        },
        "ì¡°ìš©í•œ": {
            "positive": [
                "ì¡°ìš©", "ì°¨ë¶„", "ì •ìˆ™", "í‰í™”", "ê³ ìš”", "íë§", "í•œì ",
                "ì†ŒìŒ ì—†ëŠ”", "ì‹œë„ëŸ½ì§€ ì•Šì€", "ì¡°ìš©", 
                "ì°¨ë¶„í•œ", "í‰í™”ë¡œìš´", "ê³ ìš”í•œ", "ì ë§‰", "ì •ì ",
                "íœ´ì‹", "ì‰¬ê¸° ì¢‹ì€", "í¸ì•ˆí•œ", "ì•ˆì •ì ", "ì—¬ìœ ë¡œìš´",
                "ì§‘ì¤‘", "ì§‘ì¤‘í•˜ê¸° ì¢‹ì€", "ì‚¬ìƒ‰", "ëª…ìƒ", "íë§ íƒ€ì„"
            ],
            "negative": [
                "ì‹œë„ëŸ½ë‹¤", "ì†ŒìŒ", "ë– ë“¤ì©", "ë¶ì ë¶ì ", "í˜¼ì¡"
            ]
        },
        "24ì‹œê°„": {
            "positive": [
                "24 ì‹œê°„", "24 ì‹œ", "ë°¤ëŠ¦ê²Œ", "ìƒˆë²½", "ì‹¬ì•¼", "ì˜¬ë‚˜ì‡", "24h",
                "24ì‹œ", "ì´ì‹­ì‚¬ì‹œê°„", "í•˜ë£¨ì¢…ì¼", "ì•¼ê°„", "ë°¤", "ëŠ¦ì€ ì‹œê°„",
                "ìƒˆë²½ ì‹œê°„", "ì‹¬ì•¼ ì‹œê°„", "ë°¤ìƒ˜", "ë°¤ìƒˆ",
                "ì–¸ì œë‚˜", "í•­ìƒ", "ëŠ˜", "ê³„ì†", "ë¬´ì œí•œ", "ì œí•œ ì—†ì´"
            ],
            "negative": [
                "24 ì‹œê°„ ì•„ë‹ˆë‹¤", "ì¼ì° ë‹«ë‹¤", "ë°¤ì— ë¬¸ ë‹«ë‹¤", "ëŠ¦ì€ ì‹œê°„ ì•ˆë¨"
            ]
        }
    },
    "í¸ì˜ì ": {
        "ì•¼ì™¸ì¢Œì„": {
            "positive": [
                "ì•¼ì™¸", "í…Œë¼ìŠ¤", "ë°–ì—", "ì™¸ë¶€", "ì˜¥ì™¸",
                "ë°”ê¹¥", "ë°”ê¹¥ìª½", "ì‹¤ì™¸", "ë…¸ì²œ", "ì˜¤í”ˆì—ì–´", "ì•¼ì™¸ì„",
                "ì•¼ì™¸ í…Œì´ë¸”", "ì•¼ì™¸ ì˜ì", "í…Œë¼ìŠ¤ì„", "íŒŒë¼ì†”", "ê·¸ëŠ˜ë§‰",
                "í•˜ëŠ˜", "ê³µê¸°", "ë°”ëŒ", "ìì—°", "ì‹ ì„ í•œ ê³µê¸°", "í™˜ê¸°"
            ],
            "negative": [
                "ì•¼ì™¸ ì¢Œì„ ì—†ë‹¤", "í…Œë¼ìŠ¤ ì—†ë‹¤", "ì‹¤ë‚´ë§Œ"
            ]
        },
        "ATM": {
            "positive": [
                "ATM", "í˜„ê¸ˆ ì¸ì¶œê¸°", "CD ê¸°", "ì€í–‰ ê¸°ê¸°", "ì¶œê¸ˆ",
                "í˜„ê¸ˆ", "ëˆ", "ì¸ì¶œ", "ì¶œê¸ˆê¸°", "ìë™ì¶œê¸ˆê¸°", "í˜„ê¸ˆìë™ì§€ê¸‰ê¸°",
                "ATMê¸°", "CDê¸°", "í˜„ê¸ˆì§€ê¸‰ê¸°", "ì€í–‰", "ê¸ˆê³ ", "ì¹´ë“œ",
                "ì²´í¬ì¹´ë“œ", "ì‹ ìš©ì¹´ë“œ", "í†µì¥", "ê³„ì¢Œ", "ì”ê³ ", "ìˆ˜ìˆ˜ë£Œ"
            ],
            "negative": [
                "ATM ì—†ë‹¤", "í˜„ê¸ˆ ì¸ì¶œ ë¶ˆê°€", "ëˆ ëª» ë½‘ë‹¤"
            ]
        },
        "ì·¨ì‹ê³µê°„": {
            "positive": [
                "ì·¨ì‹", "ë¨¹ì„ê³³", "í…Œì´ë¸”", "ì˜ì", "ì´íŠ¸ì¸", "ì¢Œì„",
                "ì‹ì‚¬", "ìŒì‹", "ë¨¹ê¸°", "ì•‰ì•„ì„œ", "í…Œì´ë¸”ì„", "ì˜ìì„",
                "ì·¨ì‹ ê³µê°„", "ì‹ì‚¬ ê³µê°„", "í…Œì´ë¸” ê³µê°„", "ì•‰ì„ ê³³", "ì‰´ ê³³",
                "í¸ì˜ì  í…Œì´ë¸”", "í¸ì˜ì  ì˜ì", "í¸ì˜ì  ì¢Œì„", "ê°„ì´ í…Œì´ë¸”",
                "ê°„ì´ ì˜ì", "í”Œë¼ìŠ¤í‹± í…Œì´ë¸”", "í”Œë¼ìŠ¤í‹± ì˜ì", "ë°” í…Œì´ë¸”",
                "ë†’ì€ í…Œì´ë¸”", "ìŠ¤íƒ ë”© í…Œì´ë¸”", "ì¹´ìš´í„° í…Œì´ë¸”"
            ],
            "negative": [
                "ì·¨ì‹ ê³µê°„ ì—†ë‹¤", "ë¨¹ì„ ê³³ ì—†ë‹¤", "ì•‰ì„ ê³³ ì—†ë‹¤", "í¬ì¥ë§Œ"
            ]
        }
    },
    "ì•½êµ­": {
        "ì¹œì ˆ": {
            "positive": [
                "ì¹œì ˆ", "ìƒëƒ¥", "ë‹¤ì •", "ì„¤ëª…", "ìì„¸íˆ", "ê¼¼ê¼¼",
                "ì¹œì ˆí•œ", "ìƒëƒ¥í•œ", "ë‹¤ì •í•œ", "ë”°ëœ»í•œ", "ë¶€ë“œëŸ¬ìš´", "ì •ì¤‘í•œ",
                "ì˜ˆì˜ë°”ë¥¸", "ê³µì†í•œ", "ì„¸ì‹¬í•œ", "ë°°ë ¤", "ë°°ë ¤ì‹¬", "ì„œë¹„ìŠ¤",
                "ë¯¸ì†Œ", "ì›ƒìŒ", "ì›ƒëŠ”", "ë°ì€", "í™œê¸°ì°¬", "ê¸ì •ì ",
                "ì„¤ëª… ì˜í•´ì£¼ë‹¤", "ìì„¸í•œ ì„¤ëª…", "ê¼¼ê¼¼í•œ ì„¤ëª…", "ì¹œì ˆí•œ ì„¤ëª…",
                "ìƒë‹´", "ì¡°ì–¸", "ë„ì›€", "ë„ì™€ì£¼ë‹¤", "ì±™ê²¨ì£¼ë‹¤", "ì‹ ê²½ì¨ì£¼ë‹¤",
                "ì•½ì‚¬", "ì§ì›", "ìŠ¤íƒœí”„", "ì‚¬ì¥", "ì‚¬ì¥ë‹˜", "ì›ì¥", "ì„ ìƒë‹˜"
            ],
            "negative": [
                "ë¶ˆì¹œì ˆ", "ì°¨ê°‘", "ë¬´ëšëš", "ì„¤ëª… ë¶€ì¡±", "ê·€ì°®ì•„í•˜ë‹¤"
            ]
        },
        "ë¹„ì²˜ë°©ì˜ì•½í’ˆ": {
            "positive": [
                "ì¼ë°˜ ì˜ì•½í’ˆ", "ì¼ë°˜ì•½", "OTC", "ê°ê¸°ì•½", "ë‘í†µì•½", "ì†Œí™”ì œ",
                "íŒŒìŠ¤", "ë¹„íƒ€ë¯¼", "ì²˜ë°©ì „ ì—†ì´", "ìƒë¹„ì•½",
                "ì²˜ë°©ì „ ë¶ˆí•„ìš”", "ì²˜ë°©ì „ í•„ìš” ì—†ëŠ”", "ë°”ë¡œ ì‚´ ìˆ˜ ìˆëŠ”",
                "í•´ì—´ì œ", "ì§„í†µì œ", "ì†Œì—¼ì œ", "í•­íˆìŠ¤íƒ€ë¯¼ì œ", "ì¢…í•©ê°ê¸°ì•½",
                "ê¸°ì¹¨ì•½", "ê°€ë˜ì•½", "ì½§ë¬¼ì•½", "ì½”ê°ê¸°ì•½", "ëª©ê°ê¸°ì•½",
                "ë°°íƒˆ", "ì„¤ì‚¬", "ë³€ë¹„", "ìœ„ì¥ì•½", "ì œì‚°ì œ", "ì •ì¥ì œ",
                "ì˜ì–‘ì œ", "ë³´ì¡°ì œ", "ê±´ê°•ì‹í’ˆ", "ìœ ì‚°ê· ", "ì˜¤ë©”ê°€3",
                "ë§ˆê·¸ë„¤ìŠ˜", "ì¹¼ìŠ˜", "ì² ë¶„", "ì•„ì—°", "ë¹„íƒ€ë¯¼C", "ë¹„íƒ€ë¯¼D",
                "ì—°ê³ ", "í¬ë¦¼", "ë¡œì…˜", "ë°´ë“œ", "ê±°ì¦ˆ", "ì†Œë…ì•½",
                "ì•ˆì•½", "ê·€ì•½", "ì½” ìŠ¤í”„ë ˆì´", "ëª© ìŠ¤í”„ë ˆì´", "ë¬¼ì•½"
            ],
            "negative": [
                "ì¼ë°˜ì•½ ì—†ë‹¤", "ì²˜ë°©ì „ í•„ìš”", "ì „ë¬¸ ì˜ì•½í’ˆë§Œ"
            ]
        }
    },
    "í˜¸í…”": {
        "ìŠ¤íŒŒ/ì›”í’€/ìš•ì¡°": {
            "positive": [
                "ìŠ¤íŒŒ", "ì˜¨ì²œ", "ì‚¬ìš°ë‚˜", "ì°œì§ˆ", "ìì¿ ì§€", "ì›”í’€", "ìš•ì¡°", "íë§",
                "ì˜¨ìˆ˜", "ì˜¨íƒ•", "ëƒ‰íƒ•", "ë…¸ì²œíƒ•", "ì‹¤ë‚´íƒ•", "ëŒ€ìš•ì¥", "ëª©ìš•",
                "ì…ìš•", "ë°˜ì‹ ìš•", "ì¡±ìš•", "í•œì¦ë§‰", "í™©í† ", "í¸ë°±", "ì˜¥",
                "ë§ˆì‚¬ì§€", "ì•„ë¡œë§ˆ", "í…Œë¼í”¼", "ì¹˜ë£Œ", "íœ´ì‹", "ì¬ì¶©ì „",
                "ìŠ¤íŒŒ ì‹œì„¤", "ì›°ë‹ˆìŠ¤", "íë§ ì„¼í„°", "íœ´ì–‘", "ë¦¬ì¡°íŠ¸",
                "ë¬¼ë†€ì´", "ìˆ˜ì¹˜ë£Œ", "ìˆ˜ì•• ë§ˆì‚¬ì§€", "ê¸°í¬ìš•", "ë²„ë¸”ìš•"
            ],
            "negative": [
                "ìŠ¤íŒŒ ì—†ë‹¤", "ì˜¨ì²œ ì—†ë‹¤", "ì‚¬ìš°ë‚˜ ì—†ë‹¤", "ì›”í’€ ì—†ë‹¤", "ìš•ì¡° ì—†ë‹¤"
            ]
        },
        "ë°˜ë ¤ë™ë¬¼ ë™ë°˜": {
            "positive": [
                "ë°˜ë ¤ ë™ë¬¼", "ì• ì™„ ë™ë¬¼", "í«", "ê°•ì•„ì§€", "ê³ ì–‘ì´", "ëŒ•ëŒ•ì´", "ë™ë°˜ ê°€ëŠ¥",
                "ë°˜ë ¤ê²¬", "ë°˜ë ¤ë¬˜", "ì• ê²¬", "ì• ë¬˜", "ê°œ", "ëƒ¥ì´", "ë©ë©ì´",
                "í«ë™ë°˜", "í« í”„ë Œë“¤ë¦¬", "ë™ë¬¼ ë™ë°˜", "ê°•ì•„ì§€ ë™ë°˜", "ê³ ì–‘ì´ ë™ë°˜",
                "ì• ì™„ë™ë¬¼ í—ˆìš©", "ë°˜ë ¤ë™ë¬¼ í—ˆìš©", "í« í—ˆìš©", "ë™ë¬¼ í—ˆìš©",
                "í«ìƒµ", "í«í˜¸í…”", "í«ì¹´í˜", "í« ì „ìš©", "í« ì„œë¹„ìŠ¤",
                "ì‚°ì±…", "ì• ê²¬ ë™ë°˜", "ì†Œí˜•ê²¬", "ì¤‘í˜•ê²¬", "ëŒ€í˜•ê²¬", "ê²¬ì¢…",
                "ëª©ì¤„", "ë¦¬ë“œì¤„", "í•˜ë„¤ìŠ¤", "ì• ê²¬ìš©í’ˆ", "í«ìš©í’ˆ", "ì‚¬ë£Œ"
            ],
            "negative": [
                "ë°˜ë ¤ ë™ë¬¼ ë¶ˆê°€", "ì• ì™„ ë™ë¬¼ ë¶ˆê°€", "í« ë¶ˆê°€", "ë™ë¬¼ ê¸ˆì§€"
            ]
        },
        "ì£¼ì°¨ê°€ëŠ¥": {
            "positive": [
                "ì£¼ì°¨", "ë¬´ë£Œ ì£¼ì°¨", "ì£¼ì°¨ì¥", "ì£¼ì°¨ ë©´", "ì£¼ì°¨ ìë¦¬", "ë°œë ›",
                "ë¬´ë£ŒíŒŒí‚¹", "ì£¼ì°¨ ê°€ëŠ¥", "ì£¼ì°¨ì‹œì„¤",
                "ì£¼ì°¨ê³µê°„", "ì£¼ì°¨íƒ€ì›Œ", "ì§€í•˜ì£¼ì°¨ì¥", "ì§€ìƒì£¼ì°¨ì¥", "ì˜¥ì™¸ì£¼ì°¨",
                "ì‹¤ë‚´ì£¼ì°¨", "ê¸°ê³„ì‹ì£¼ì°¨", "í‰ë©´ì£¼ì°¨", "ì…ì²´ì£¼ì°¨", "ìì£¼ì‹ì£¼ì°¨",
                "ì…€í”„ì£¼ì°¨", "ë°œë ›íŒŒí‚¹", "ì£¼ì°¨ìš”ê¸ˆ", "ì£¼ì°¨ë¹„", "ì£¼ì°¨í• ì¸",
                "ë¬´ë£Œì£¼ì°¨", "ì£¼ì°¨ ì„œë¹„ìŠ¤", "íŒŒí‚¹ ì„œë¹„ìŠ¤", "ì£¼ì°¨ í¸ì˜",
                "ì£¼ì°¨ ì—¬ìœ ", "ë„“ì€ ì£¼ì°¨", "ì£¼ì°¨ ë„‰ë„‰", "ì°¨ëŸ‰", "ìë™ì°¨", "ìŠ¹ìš©ì°¨"
            ],
            "negative": [
                "ì£¼ì°¨ ì–´ë µë‹¤", "ì£¼ì°¨ì¥ ì—†ë‹¤", "ì£¼ì°¨ ë¶ˆê°€", "ì£¼ì°¨ë¹„ ë¹„ì‹¸ë‹¤"
            ]
        },
        "ì „ê¸°ì°¨ ì¶©ì „": {
            "positive": [
                "ì „ê¸°ì°¨", "ì „ê¸° ì¶©ì „", "ì¶©ì „ì†Œ", "ì¶©ì „ê¸°", "EV", "ì „ê¸° ìë™ì°¨",
                "ì „ê¸°ì°¨ ì¶©ì „", "EV ì¶©ì „", "ê¸‰ì†ì¶©ì „", "ì™„ì†ì¶©ì „", "ì¶©ì „ì‹œì„¤",
                "ì¶©ì „ ì„œë¹„ìŠ¤", "ì¶©ì „ ìŠ¤í…Œì´ì…˜", "ì°¨ì§€ë¹„", "í™˜ê²½ì°¨", "ì¹œí™˜ê²½ì°¨",
                "í•˜ì´ë¸Œë¦¬ë“œ", "í”ŒëŸ¬ê·¸ì¸", "ë°°í„°ë¦¬", "ì „ë ¥", "ì „ì›", "ì½˜ì„¼íŠ¸",
            ],
            "negative": [
                "ì „ê¸°ì°¨ ì¶©ì „ ì—†ë‹¤", "ì¶©ì „ì†Œ ì—†ë‹¤", "ì¶©ì „ ë¶ˆê°€"
            ]
        },
        "ê°ì‹¤ê¸ˆì—°": {
            "positive": [
                "ê¸ˆì—°", "ê°ì‹¤ ê¸ˆì—°", "í¡ì—° ê¸ˆì§€", "ê¸ˆì—° ê°ì‹¤", "ê¹¨ë—í•œ ê³µê¸°",
                "ê¸ˆì—°ì‹¤", "ë¹„í¡ì—°",
                "ë‹´ë°° ê¸ˆì§€", "í¡ì—° ë¶ˆê°€", "ê¸ˆì—° êµ¬ì—­", "ê¸ˆì—° ì§€ì—­", "ê¸ˆì—° í˜¸í…”",
                "ê¹¨ë—í•œ", "ìƒì¾Œí•œ", "ì‹ ì„ í•œ", "ë§‘ì€ ê³µê¸°", "ê³µê¸° ì²­ì •",
                "ëƒ„ìƒˆ ì—†ëŠ”", "ë‹´ë°° ëƒ„ìƒˆ ì—†ëŠ”", "ì—°ê¸° ì—†ëŠ”", "ê±´ê°•", "ì›°ë¹™"
            ],
            "negative": [
                "ê¸ˆì—° ì•„ë‹ˆë‹¤", "í¡ì—° ê°€ëŠ¥", "ê¸ˆì—° ê°ì‹¤ ì—†ë‹¤"
            ]
        },
        "OTT": {
            "positive": [
                "OTT", "ë„·í”Œë¦­ìŠ¤", "ìœ íŠœë¸Œ", "ì›¨ì´ë¸Œ", "í‹°ë¹™", "ìŠ¤íŠ¸ë¦¬ë°", "TV",
                "ë„·í”Œ", "ìœ íˆ¬ë¸Œ", "ë””ì¦ˆë‹ˆ", "ë””ì¦ˆë‹ˆí”ŒëŸ¬ìŠ¤", "ì•„ë§ˆì¡´", "í”„ë¼ì„",
                "ì• í”ŒTV", "ì™“ì± ", "ì¿ íŒ¡í”Œë ˆì´", "ì‹œì¦Œ", "ë“œë¼ë§ˆ", "ì˜í™”",
                "ì˜ˆëŠ¥", "ë‹¤í", "ì• ë‹ˆ", "ë§Œí™”", "ì½˜í…ì¸ ", "VOD", "ë™ì˜ìƒ",
                "ë¯¸ë””ì–´", "ì—”í„°í…Œì¸ë¨¼íŠ¸", "ì‹œì²­", "ê°ìƒ", "ê´€ëŒ", "ì¬ìƒ",
                "ìŠ¤ë§ˆíŠ¸TV", "ì¸í„°ë„·TV", "IPTV", "ì¼€ì´ë¸”", "ìœ„ì„±", "ë””ì§€í„¸"
            ],
            "negative": [
                "OTT ì—†ë‹¤", "ë„·í”Œë¦­ìŠ¤ ì—†ë‹¤", "TV ì—†ë‹¤", "ìŠ¤íŠ¸ë¦¬ë° ë¶ˆê°€"
            ]
        },
        "ìˆ˜ì˜ì¥": {
            "positive": [
                "ìˆ˜ì˜ì¥", "í’€", "ë¬¼ë†€ì´", "í‚¤ì¦ˆ í’€", "ì¸í”¼ë‹ˆí‹°",
                "ì•¼ì™¸ ìˆ˜ì˜ì¥", "ì‹¤ë‚´ ìˆ˜ì˜ì¥", "ì˜¥ìƒ ìˆ˜ì˜ì¥", "ë£¨í”„íƒ‘ í’€",
                "ì–´ë¦°ì´ ìˆ˜ì˜ì¥", "ì„±ì¸ ìˆ˜ì˜ì¥", "ì˜¨ìˆ˜ ìˆ˜ì˜ì¥", "ëƒ‰ìˆ˜ í’€",
                "ìˆ˜ì˜", "í—¤ì—„", "ë¬¼", "ì›Œí„°", "ì•„ì¿ ì•„", "ë¦¬ì¡°íŠ¸", "íœ´ì–‘",
                "ë ˆì €", "ì•¡í‹°ë¹„í‹°", "ìš´ë™", "í”¼íŠ¸ë‹ˆìŠ¤", "ê±´ê°•", "ë‹¤ì´ì–´íŠ¸",
                "ìˆ˜ìƒ", "ì›Œí„°íŒŒí¬", "ë¬¼ë†€ì´ì¥", "í’€ì‚¬ì´ë“œ", "ì„ ë² ë“œ", "íŒŒë¼ì†”"
            ],
            "negative": [
                "ìˆ˜ì˜ì¥ ì—†ë‹¤", "ë¬¼ë†€ì´ ë¶ˆê°€", "ìˆ˜ì˜ ë¶ˆê°€"
            ]
        },
        "ê°ì‹¤ë‚´ PC": {
            "positive": [
                "PC", "ì»´í“¨í„°", "ë…¸íŠ¸ë¶", "ì¸í„°ë„·", "ì™€ì´íŒŒì´", "ì½˜ì„¼íŠ¸",
                "ëª¨ë‹ˆí„°",
                "í‚¤ë³´ë“œ", "ë§ˆìš°ìŠ¤", "í”„ë¦°í„°", "ìŠ¤ìºë„ˆ", "ì—…ë¬´", "ë¹„ì¦ˆë‹ˆìŠ¤",
                "ì‘ì—…", "ì¼", "íšŒì‚¬", "ì¶œì¥",
                "ì›ê²©ê·¼ë¬´", "ì¬íƒê·¼ë¬´", "í™”ìƒíšŒì˜", "ì˜¨ë¼ì¸", "í´ë¼ìš°ë“œ",
                "ì´ë©”ì¼", "ë¬¸ì„œ", "ì—‘ì…€", "íŒŒì›Œí¬ì¸íŠ¸", "ì›Œë“œ", "í•œê¸€",
                "ì†Œí”„íŠ¸ì›¨ì–´", "í”„ë¡œê·¸ë¨", "ì•±", "ì• í”Œë¦¬ì¼€ì´ì…˜", "ì „ì›", "ì¶©ì „"
            ],
            "negative": [
                "PC ì—†ë‹¤", "ì»´í“¨í„° ì—†ë‹¤", "ì¸í„°ë„· ì—†ë‹¤", "ì™€ì´íŒŒì´ ì—†ë‹¤"
            ]
        },
        "ë°”ë² í": {
            "positive": [
                "ë°”ë² í", "BBQ", "ê·¸ë¦´", "ì•¼ì™¸ ìš”ë¦¬", "ê³ ê¸° êµ½ê¸°", "íŒŒí‹°",
                "ê³ ê¸°", "ì‚¼ê²¹ì‚´", "ê°ˆë¹„", "ì†Œê³ ê¸°", "ë¼ì§€ê³ ê¸°", "ì¹˜í‚¨", "ë‹­",
                "ì•¼ì™¸", "í…Œë¼ìŠ¤", "ì •ì›", "ë§ˆë‹¹", "ë°œì½”ë‹ˆ", "ë£¨í”„íƒ‘", "ìº í•‘",
                "ìˆ¯", "ì„íƒ„", "ê°€ìŠ¤", "ì „ê¸°", "ê·¸ë¦´íŒ¬", "ë¶ˆíŒ", "ì² íŒ",
                "ìš”ë¦¬", "êµ¬ì´", "ë¡œìŠ¤íŒ…", "í›ˆì œ", "ìŠ¤ëª¨í‚¹", "ì‹œì¦ˆë‹",
                "ê°€ì¡±", "ì¹œêµ¬", "ëª¨ì„", "íŒŒí‹°", "í–‰ì‚¬", "ì´ë²¤íŠ¸", "ì¶•ì œ"
            ],
            "negative": [
                "ë°”ë² í ì—†ë‹¤", "ê·¸ë¦´ ì—†ë‹¤", "ì•¼ì™¸ ìš”ë¦¬ ë¶ˆê°€"
            ]
        },
        "ì¡°ì‹": {
            "positive": [
                "ì¡°ì‹", "ì•„ì¹¨ ì‹ì‚¬", "ëª¨ë‹", "ë·”í˜", "ì‹ì‚¬ ì œê³µ",
                "ì•„ì¹¨", "ë¸ŒëŸ°ì¹˜", "ì‹ë‹¹",
                "ë ˆìŠ¤í† ë‘", "ë‹¤ì´ë‹", "ìŒì‹", "ë©”ë‰´",
                "í•œì‹", "ì–‘ì‹", "ì¼ì‹", "ì¤‘ì‹", "ì•„ì‹œì•ˆ", "ì»¨í‹°ë„¨íƒˆ",
                "ë¹µ", "ì‹œë¦¬ì–¼", "ê³¼ì¼", "ìš”ê±°íŠ¸", "ìš°ìœ ", "ì£¼ìŠ¤", "ì»¤í”¼",
                "ì°¨", "ê³„ë€", "ë² ì´ì»¨", "ì†Œì‹œì§€", "í† ìŠ¤íŠ¸", "ìƒëŸ¬ë“œ",
                "ë¬´ë£Œ ì¡°ì‹", "ì¡°ì‹ í¬í•¨", "ì¡°ì‹ ì„œë¹„ìŠ¤", "ì¡°ì‹ ì œê³µ",
                "ì•„ì¹¨ ë·”í˜", "ì¡°ì‹ ë·”í˜", "ì…€í”„ ì„œë¹„ìŠ¤", "ì˜¬ì¸í´ë£¨ì‹œë¸Œ"
            ],
            "negative": [
                "ì¡°ì‹ ì—†ë‹¤", "ì•„ì¹¨ ì‹ì‚¬ ë¶ˆê°€", "ì‹ì‚¬ ì œê³µ ì•ˆí•¨"
            ]
        }
    },
    "í—¤ì–´ìƒµ": {
        "ì¸ê¸°ë§ì€": {
            "positive": [
                "ì¸ê¸°", "ìœ ëª…", "ì˜ˆì•½ ì–´ë µë‹¤", "ì›¨ì´íŒ…", "ì˜í•˜ëŠ”", "ì‹¤ë ¥",
                "í•«í•œ",
                "í•«í”Œ", "í•«ìƒµ", "ì¸ê¸°ìƒµ", "ìœ ëª…ìƒµ", "ë§›ì§‘", "í—¤ì–´ ë§›ì§‘",
                "ì˜ˆì•½ í•„ìˆ˜", "ì˜ˆì•½ ëŒ€ê¸°", "ì˜ˆì•½ ë°€ë¦¼", "ë¶ë¹„ëŠ”", "ë°”ìœ",
                "ì†œì”¨", "ê¸°ìˆ ", "í…Œí¬ë‹‰", "ì „ë¬¸", "ìˆ™ë ¨", "ê²½í—˜", "ë² í…Œë‘",
                "ì›ì¥", "ì‹¤ì¥", "ë””ìì´ë„ˆ", "ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸", "ì•„í‹°ìŠ¤íŠ¸",
                "SNS", "ì¸ìŠ¤íƒ€", "ë¸”ë¡œê·¸", "í›„ê¸°", "ë¦¬ë·°", "ì¶”ì²œ", "ì†Œë¬¸",
                "ì…ì†Œë¬¸", "ë°©ì†¡", "TV", "ì—°ì˜ˆì¸", "ì…€ëŸ½", "ì•„ì´ëŒ",
                "íŠ¸ë Œë“œ", "ìœ í–‰", "ìµœì‹ ", "ê°ê°", "ì„¼ìŠ¤", "ìŠ¤íƒ€ì¼"
            ],
            "negative": [
                "ì˜ˆì•½ ì‰½ë‹¤", "í•œì‚°", "ìœ ëª…í•˜ì§€ ì•Šë‹¤"
            ]
        },
        "ì¿ í°ë©¤ë²„ì‹­": {
            "positive": [
                "ì¿ í°", "í• ì¸", "ë©¤ë²„ì‹­", "ì ë¦½", "ì´ë²¤íŠ¸", "í˜œíƒ",
                "í¬ì¸íŠ¸", "ìŠ¤íƒ¬í”„", "ì ë¦½ê¸ˆ", "ìºì‹œë°±", "ë¦¬ì›Œë“œ", "ë³´ìƒ",
                "íšŒì›", "VIP", "ìš°ëŒ€", "íŠ¹ê°€", "ì„¸ì¼", "í”„ë¡œëª¨ì…˜",
                "ì´ë²¤íŠ¸", "íŠ¹ë³„", "í•œì •", "ê¸°ê°„ í•œì •", "ì‹ ê·œ ê³ ê°",
                "ì¬ë°©ë¬¸", "ë‹¨ê³¨", "ê³ ê°", "ì„œë¹„ìŠ¤", "ë¬´ë£Œ", "ê³µì§œ",
                "1+1", "ë°˜ê°’", "50%", "30%", "20%", "10%", "í• ì¸ìœ¨"
            ],
            "negative": [
                "ì¿ í° ì—†ë‹¤", "í• ì¸ ì•ˆë¨", "í˜œíƒ ì—†ë‹¤"
            ]
        },
        "ì˜ˆì•½í•„ìˆ˜": {
            "positive": [
                "ì˜ˆì•½ í•„ìˆ˜", "ì‚¬ì „ ì˜ˆì•½", "ë¯¸ë¦¬", "ì˜ˆì•½ì œ",
                "ì˜ˆì•½ë§Œ", "ì˜ˆì•½ ì „ìš©", "ì™„ì „ ì˜ˆì•½ì œ", "100% ì˜ˆì•½ì œ",
                "ì‚¬ì „ ì—°ë½", "ë¯¸ë¦¬ ì—°ë½", "ì „í™” ì˜ˆì•½", "ì˜¨ë¼ì¸ ì˜ˆì•½",
                "ì•± ì˜ˆì•½", "ì¹´ì¹´ì˜¤í†¡", "ë„¤ì´ë²„", "ì¸ìŠ¤íƒ€", "DM", "ë¬¸ì",
                "ì˜ˆì•½ ì‹œìŠ¤í…œ", "ì˜ˆì•½ ì•±", "ì˜ˆì•½ ì‚¬ì´íŠ¸", "ì˜ˆì•½ í”Œë«í¼",
                "ì‹œê°„ ì˜ˆì•½", "ë‚ ì§œ ì˜ˆì•½", "ìŠ¤ì¼€ì¤„", "ì¼ì •", "íƒ€ì„",
                "ëŒ€ê¸°", "ì›¨ì´íŒ…", "ìˆœì„œ", "ì°¨ë¡€", "ë²ˆí˜¸í‘œ", "ìˆœë²ˆ"
            ],
            "negative": [
                "ì˜ˆì•½ ì•ˆí•´ë„ ë¨", "ë°”ë¡œ ë°©ë¬¸", "ì›Œí‚¹ ê°€ëŠ¥"
            ]
        }
    },
    "ë³‘ì›": {
        "ì‘ê¸‰ì‹¤": {
            "positive": [
                "ì‘ê¸‰ì‹¤", "ì‘ê¸‰", "24 ì‹œê°„", "ì¢…í•© ë³‘ì›", "ER", "êµ¬ê¸‰ì°¨",
                "ì‘ê¸‰ ì˜ë£Œ", "ì‘ê¸‰ ì¹˜ë£Œ", "ì‘ê¸‰ í™˜ì", "ì‘ê¸‰ ìƒí™©", "ìœ„ê¸‰",
                "ê¸‰í•œ", "ê¸´ê¸‰", "ì¦‰ì‹œ", "ë°”ë¡œ", "ì‹ ì†", "ë¹ ë¥¸", "ë‹¹ì¥",
                "24ì‹œ", "ì´ì‹­ì‚¬ì‹œê°„", "í•˜ë£¨ì¢…ì¼", "ì•¼ê°„", "ìƒˆë²½", "ë°¤",
                "ëŠ¦ì€ ì‹œê°„", "ì‹¬ì•¼", "ì˜¬ë‚˜ì‡", "ì–¸ì œë‚˜", "í•­ìƒ", "ëŠ˜",
                "ì¢…í•©ë³‘ì›", "ëŒ€í•™ë³‘ì›", "ìƒê¸‰ì¢…í•©ë³‘ì›", "í° ë³‘ì›", "ëŒ€í˜•ë³‘ì›",
                "ì˜ë£Œì§„", "ì˜ì‚¬", "ê°„í˜¸ì‚¬", "ì‘ê¸‰ì˜í•™ê³¼", "ì™¸ìƒì„¼í„°"
            ],
            "negative": [
                "ì‘ê¸‰ì‹¤ ì—†ë‹¤", "ì‘ê¸‰ ë¶ˆê°€", "24 ì‹œê°„ ì•„ë‹ˆë‹¤"
            ]
        },
        "ì „ë¬¸ì˜": {
            "positive": [
                "ì „ë¬¸ì˜", "ì „ë¬¸ê°€", "êµìˆ˜", "ë°•ì‚¬", "ìŠ¤í˜ì…œë¦¬ìŠ¤íŠ¸",
                "ì „ë¬¸ ì˜ì‚¬", "ë¶„ê³¼ ì „ë¬¸ì˜", "ì„¸ë¶€ ì „ë¬¸ì˜", "ì„ìƒ êµìˆ˜",
                "ì£¼ì¹˜ì˜", "ë‹´ë‹¹ì˜", "ì›ì¥", "ê³¼ì¥", "ë¶€ì¥", "ì‹¤ì¥",
                "ê²½í—˜", "ì‹¤ë ¥", "ìˆ™ë ¨", "ë² í…Œë‘", "ë…¸í•˜ìš°", "ê¸°ìˆ ", "ì†œì”¨"
            ],
            "negative": [
                "ì „ë¬¸ì˜ ì—†ë‹¤", "ì¼ë°˜ì˜", "ì „ë¬¸ ì§„ë£Œ ë¶ˆê°€"
            ]
        },
        "ì•¼ê°„ì§„ë£Œ": {
            "positive": [
                "ì•¼ê°„", "ë°¤", "ì €ë…", "24 ì‹œê°„", "ì‹¬ì•¼", "ë‹¹ì§",
                "ì•¼ê°„ ì§„ë£Œ", "ë°¤ ì§„ë£Œ", "ì €ë… ì§„ë£Œ", "ëŠ¦ì€ ì‹œê°„", "ëŠ¦ê²Œ",
                "24ì‹œ", "24ì‹œê°„", "ì´ì‹­ì‚¬ì‹œê°„", "í•˜ë£¨ì¢…ì¼", "ì˜¬ë‚˜ì‡",
                "ìƒˆë²½", "ìƒˆë²½ ì§„ë£Œ", "ì‹¬ì•¼ ì§„ë£Œ", "ë°¤ìƒ˜", "í†µë°¤", "ì˜¬ë°¤",
                "ë‹¹ì§ì˜", "ë‹¹ì§ ì˜ì‚¬", "ì•¼ê°„ ì˜ì‚¬", "ì‘ê¸‰", "ì‘ê¸‰ì‹¤",
                "ì‘ê¸‰ ì§„ë£Œ", "ê¸´ê¸‰", "ê¸‰í•œ", "ìœ„ê¸‰", "ì¦‰ì‹œ", "ë°”ë¡œ",
                "ì–¸ì œë‚˜", "í•­ìƒ", "ëŠ˜", "ê³„ì†", "ë¬´ì œí•œ", "ì œí•œ ì—†ì´"
            ],
            "negative": [
                "ì•¼ê°„ ì§„ë£Œ ì—†ë‹¤", "ì¼ì° ë‹«ë‹¤", "ë°¤ì— ì•ˆë¨"
            ]
        }
    }
}


# ê·œì¹™/ì‚¬ì „ ê¸°ë°˜ ì„¤ì • ë¡œë”© ì™„ë£Œ ë¡œê·¸
print("ê·œì¹™ ê¸°ë°˜ íŒŒì„œ ë¡œë”© ì™„ë£Œ!")

class ChatRequest(BaseModel):
    message: str
    selected_location: Optional[str] = None
    pending: Optional[Dict[str, Any]] = None


class ChatResponse(BaseModel):
    reply: str
    places: list | None = None
    action: Optional[str] = None
    candidates: Optional[List[str]] = None
    pending: Optional[Dict[str, Any]] = None


app = FastAPI(title="MAPro Chat API", version="0.1.0")
# ê³µìš© ë„ì›€ë§ ë©”ì‹œì§€
HELP_MESSAGE = (
    "ì…ë ¥ì´ ë„ˆë¬´ ê°„ë‹¨í•´ìš”! ğŸ˜…\n\n"
    "ğŸ’¡ ì˜¬ë°”ë¥¸ ì…ë ¥ ì˜ˆì‹œ:\n"
    "â€¢ \"ê°•ë‚¨êµ¬ ë¶„ìœ„ê¸°ì¢‹ì€ ì¹´í˜\"\n"
    "â€¢ \"íŒêµ 24ì‹œê°„ í¸ì˜ì \"\n"

    "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ë§¤ì¥ ì¢…ë¥˜:\n"
    "ìŒì‹ì , ì¹´í˜, í¸ì˜ì , ì•½êµ­, í˜¸í…”, í—¤ì–´ìƒµ, ë³‘ì›\n\n"
)


# ------------------ ì™¸ë¶€ API ì„¤ì • (í–‰ì•ˆë¶€ ì£¼ì†Œ API) ------------------
# ì‹¤ì œ ë°°í¬ ì‹œ í™˜ê²½ë³€ìˆ˜ MOIS_API_KEYë¡œ ì£¼ì…. ë¯¸ì„¤ì • ì‹œ ì•„ë˜ ê¸°ë³¸ê°’ ì‚¬ìš©
# ------------------ ì™¸ë¶€ API ì„¤ì • ------------------

def is_low_quality_input(text: str) -> bool:
    """ì˜ë¯¸ ì—†ëŠ” ì…ë ¥(ê¸°í˜¸ë§Œ, ë„ˆë¬´ ì§§ìŒ ë“±)ì„ íŒë³„."""
    if not text:
        return True
    # ê³µë°± ì œê±° í›„ ì˜ìˆ«ì/í•œê¸€ë§Œ ë‚¨ê¹€
    cleaned = re.sub(r"[^0-9A-Za-zê°€-í£]", "", text)
    # ì „ë¶€ ê¸°í˜¸ì´ê±°ë‚˜ ìœ íš¨ ê¸€ì ìˆ˜ê°€ 2 ë¯¸ë§Œ
    if len(cleaned) < 2:
        return True
    # í•œê¸€/ì˜ë¬¸/ìˆ«ì ì¤‘ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë¬´ì˜ë¯¸
    if not re.search(r"[0-9A-Za-zê°€-í£]", text):
        return True
    return False


# CORS ì„¤ì •
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], # ëª¨ë“  origin í—ˆìš©
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# /chat ì—”ë“œí¬ì¸íŠ¸ ì´ì „ì— ì¶”ê°€
def clean_location_query(text: str, category: str, features: list) -> str:
    """ì‚¬ìš©ì ë©”ì‹œì§€ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ íŠ¹ì§• ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì œê±°í•˜ì—¬ ì§€ì—­ëª…ë§Œ ë‚¨ê¹ë‹ˆë‹¤."""
    cleaned_text = text
    
    # ì¹´í…Œê³ ë¦¬ ê´€ë ¨ í‘œí˜„ ì œê±°
    if category and category in CATEGORY_PHRASES:
        for phrase in CATEGORY_PHRASES[category]:
            cleaned_text = cleaned_text.replace(phrase, "")
            
    # íŠ¹ì§• ê´€ë ¨ í‘œí˜„ ì œê±°
    if category and features:
        for feature in features:
            if feature in KEYWORD_DICT.get(category, {}):
                all_phrases = KEYWORD_DICT[category][feature].get("positive", []) + \
                              KEYWORD_DICT[category][feature].get("negative", [])
                for phrase in all_phrases:
                    # ë„ˆë¬´ ì§§ì€ ë‹¨ì–´ê°€ ë‹¤ë¥¸ ë‹¨ì–´ì˜ ì¼ë¶€ë¥¼ ì§€ìš°ëŠ” ê²ƒì„ ë°©ì§€
                    if len(phrase) > 1:
                         cleaned_text = cleaned_text.replace(phrase, "")

    # ê³µë°± ì •ë¦¬ í›„ ë°˜í™˜
    return " ".join(cleaned_text.split())

# chat_endpoint
@app.post("/chat", response_model=ChatResponse)
def chat_endpoint(req: ChatRequest):
    user_message = (req.message or "").strip()
    # í›„ì† ìš”ì²­(ì§€ì—­ ì„ íƒ) ì²˜ë¦¬
    if req.selected_location and req.pending:
        try:
            category = (req.pending or {}).get("category")
            features = (req.pending or {}).get("features") or []
            if not category:
                return ChatResponse(reply=HELP_MESSAGE, places=None)
            extracted = {"category": category, "features": features, "location": req.selected_location}
            matched_places = query_places(extracted)
            if matched_places:
                reply_text = build_reply(extracted, matched_places)
                return ChatResponse(reply=reply_text, places=matched_places[:5])
            else:
                return ChatResponse(reply="ì¡°ê±´ì— ë§ëŠ” ë§¤ì¥ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ ë³´ì‹œê² ì–´ìš”?", places=None)
        except Exception as e:
            print(f"í›„ì† ì„ íƒ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
            return ChatResponse(reply="ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", places=None)

    if not user_message:
        return ChatResponse(reply="ë©”ì‹œì§€ê°€ ë¹„ì–´ ìˆì–´ìš”.")

    try:
        # 0) ì…ë ¥ ìœ íš¨ì„± 1ì°¨ í•„í„°
        if is_low_quality_input(user_message):
            return ChatResponse(reply=HELP_MESSAGE, places=None)

        # 1) NLP: ì¹´í…Œê³ ë¦¬/íŠ¹ì„± ë¨¼ì € ì¶”ì¶œ
        category = classify_category_with_rules(user_message)
        features = extract_features_with_rules(user_message, category)
        
        # 2) [ìˆ˜ì •ëœ ë¡œì§] ì§€ì—­ëª… ê²€ìƒ‰ì„ ìœ„í•œ ì¿¼ë¦¬ ì •ì œ
        location_query = clean_location_query(user_message, category, features)
        
        extracted = {"category": category, "features": features, "location": None}

        # 3) [ìˆ˜ì •ëœ ë¡œì§] ì •ì œëœ ì¿¼ë¦¬ë¡œë§Œ ì§€ì—­ í›„ë³´ ê²€ìƒ‰
        cand_from_text = []
        if location_query: # ì •ì œëœ ì¿¼ë¦¬ê°€ ìˆì„ ë•Œë§Œ ì§€ì—­ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            try:
                # API í˜¸ì¶œ ìµœì†Œí™”ë¥¼ ìœ„í•´ resolve_single_location ëŒ€ì‹  get_location_candidatesë¥¼ ì‚¬ìš©
                cand_from_text = location_service.get_location_candidates(location_query, timeout_sec=1.0)
            except Exception as e:
                print(f"Location candidate search error: {e}")
                cand_from_text = []

        if cand_from_text:
            if len(cand_from_text) == 1:
                extracted["location"] = cand_from_text[0]
            # ì—¬ëŸ¬ ì§€ì—­ì´ ê²€ìƒ‰ë˜ì—ˆê³ , ì¹´í…Œê³ ë¦¬ê°€ ëª…í™•í•  ë•Œë§Œ ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­
            elif len(cand_from_text) > 1 and category:
                return ChatResponse(
                    reply="ì—¬ëŸ¬ ì§€ì—­ì´ ê²€ìƒ‰ë˜ì—ˆì–´ìš”. ì›í•˜ì‹œëŠ” ì§€ì—­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.",
                    places=None,
                    action="choose_location",
                    candidates=cand_from_text,
                    pending={"category": category, "features": features}
                )

        location = extracted.get("location")

        # 4) [ìˆ˜ì •ëœ ë¡œì§] í•„ìˆ˜ ì •ë³´(ì§€ì—­, ì¹´í…Œê³ ë¦¬) ê²€ì¦
        if not category:
            # ì¹´í…Œê³ ë¦¬ê°€ ì—†ëŠ” ê²½ìš° (ì§€ì—­ ì •ë³´ ìœ ë¬´ì™€ ìƒê´€ì—†ì´)
            location_display = f"'{location}'ì—ì„œ" if location else ""
            return ChatResponse(reply=f"{location_display} ì–´ë–¤ ì¥ì†Œë¥¼ ì°¾ìœ¼ì„¸ìš”? ğŸ‘€\n(ì˜ˆ: ìŒì‹ì , ì¹´í˜, ì•½êµ­ ë“±)".strip(), places=None)
        
        if not location:
            # ì¹´í…Œê³ ë¦¬ëŠ” ìˆì§€ë§Œ ì§€ì—­ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°
            return ChatResponse(reply=f"ì–´ëŠ ì§€ì—­ì—ì„œ {category}ì„(ë¥¼) ì°¾ìœ¼ì‹œë‚˜ìš”? ğŸ¤”\nì˜ˆ: \"ê°•ë‚¨ {category}\"", places=None)

        # 5) ëª¨ë“  ì •ë³´ê°€ í™•ì •ë˜ì—ˆìœ¼ë¯€ë¡œ DB ì¡°íšŒ ë° ì‘ë‹µ ìƒì„±
        matched_places = query_places(extracted)
        
        if matched_places:
            reply_text = build_reply(extracted, matched_places)
            return ChatResponse(reply=reply_text, places=matched_places[:5])
        else:
            return ChatResponse(reply="ì¡°ê±´ì— ë§ëŠ” ë§¤ì¥ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ ë³´ì‹œê² ì–´ìš”?", places=None)
            
    except Exception as e:
        print(f"ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸ ì˜¤ë¥˜: {e}") # ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
        return ChatResponse(reply="ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", places=None)


@app.get("/health")
def health_check():
    try:
        # DB ì—°ê²° í…ŒìŠ¤íŠ¸
        engine = get_db_engine()
        with engine.connect() as conn:
            conn.execute(text("SELECT 1"))
        return {"status": "ok", "database": "connected"}
    except Exception as e:
        return {"status": "error", "database": "disconnected", "error": str(e)}
#ë™ì„ api  


# ë™ì„ API ì¶”ê°€ (ê¸°ì¡´ DB ì—°ê²° ë°©ì‹ ì‚¬ìš©)
@app.get("/db/export")
def export_places():
    """ì „ì²´ ë§¤ì¥ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ export"""
    try:
        engine = get_db_engine()
        with engine.connect() as conn:
            result = conn.execute(text("SELECT * FROM place")).fetchall()
            return [dict(row._mapping) for row in result]
    except Exception as e:
        return {"error": str(e)}

@app.get("/db/schema")
def get_db_schema():
    """DB í…Œì´ë¸” êµ¬ì¡°ë¥¼ ë°˜í™˜í•˜ëŠ” API"""
    try:
        engine = get_db_engine()
        with engine.connect() as conn:
            # í…Œì´ë¸” êµ¬ì¡° ì¡°íšŒ
            schema_query = text("DESCRIBE place")
            schema_result = conn.execute(schema_query).fetchall()
            
            # ìƒ˜í”Œ ë°ì´í„° ì¡°íšŒ (5ê°œë§Œ)
            sample_query = text("SELECT * FROM place LIMIT 5")
            sample_result = conn.execute(sample_query).fetchall()
            
            return {
                "schema": [dict(row._mapping) for row in schema_result],
                "sample_data": [dict(row._mapping) for row in sample_result]
            }
    except Exception as e:
        return {"error": str(e)}

@app.post("/send-to-map")
def send_places_to_map(places: List[dict]):
    """ì±—ë´‡ ê²°ê³¼ë¥¼ ì§€ë„ APIë¡œ ì „ì†¡"""
    try:
        import requests
        response = requests.post(
            "http://34.64.120.99:5000/api/chat-places",
            json={"places": places},
            timeout=5
        )
        return {"status": "success", "map_response": response.json()}
    except Exception as e:
        return {"status": "error", "message": str(e)}

@app.get("/test/places")
def test_places():
    """í…ŒìŠ¤íŠ¸ìš© - íŒêµ ì§€ì—­ ë°ì´í„° í™•ì¸"""
    try:
        engine = get_db_engine()
        with engine.connect() as conn:
            result = conn.execute(text("SELECT * FROM place WHERE location LIKE '%íŒêµ%' LIMIT 10")).fetchall()
            return [dict(row._mapping) for row in result]
    except Exception as e:
        return {"error": str(e)}
# ------------------ ì„¤ì •/DB ------------------
load_dotenv()

def get_engine() -> Engine:
    host = os.getenv("DB_HOST", "mapro.cloud")
    port = os.getenv("DB_PORT", "3306")
    user = os.getenv("DB_USER", "dev")
    password = os.getenv("DB_PASSWORD", "Dev1010**")
    name = os.getenv("DB_NAME", "mapro")
    
    # mariadb+mariadbconnectorì—ì„œ mysql+pymysqlë¡œ ë³€ê²½
    url = f"mysql+pymysql://{user}:{password}@{host}:{port}/{name}?charset=utf8mb4"
    return create_engine(url, pool_pre_ping=True)

ENGINE: Optional[Engine] = None

def get_db_engine() -> Engine:
    global ENGINE
    if ENGINE is None:
        ENGINE = get_engine()
    return ENGINE

# ------------------ í…ìŠ¤íŠ¸ íŒŒì‹± ------------------
def normalize(text: str) -> str:
    return text.strip()


def classify_category_with_rules(text: str) -> str:
    """ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜: ì¹´í…Œê³ ë¦¬ ë§¤í•‘(CATEGORY_PHRASES)ì—ì„œ 1ê°œë§Œ ë§¤ì¹­ë  ë•Œ ì¸ì •.
    - ê³µë°±/ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ê°„ë‹¨ ì •ê·œí™” ì§€ì›
    - ë‹¤ì¤‘ ë§¤ì¹­ ì‹œ ëª¨í˜¸ íŒì •(None)
    """
    if not text:
        return None

    def norm(s: str) -> str:
        return re.sub(r"\s+", "", (s or "").lower())

    t = norm(text)

    matched_labels = []
    for label, phrases_raw in CATEGORY_PHRASES.items():
        phrases = [norm(p) for p in phrases_raw if p]
        for p in phrases:
            if p and p in t:
                matched_labels.append(label)
                break

    matched_labels = list(dict.fromkeys(matched_labels))
    if len(matched_labels) == 1:
        return matched_labels[0]
    return None


def extract_features_with_rules(text: str, category: str) -> list:
    """ì‚¬ì „ì— ì •ì˜ëœ positive/negative í‘œí˜„ìœ¼ë¡œë§Œ íŠ¹ì„±ì„ ì¶”ì¶œí•œë‹¤.
    - ì¹´í…Œê³ ë¦¬ê°€ ì£¼ì–´ì§€ë©´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë§Œ ê²€ì‚¬
    - ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ íŠ¹ì„±ì„ ê²€ì‚¬í•˜ë˜, ë¶€ì • í‘œí˜„ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì œì™¸
    - ê³µë°± ë¬´ì‹œ ë§¤ì¹­ ì§€ì› (ì˜ˆ: "24 ì‹œê°„" â†” "24ì‹œê°„")
    """
    if not text:
        return []

    def norm(s: str) -> str:
        return re.sub(r"\s+", "", s or "")

    text_norm = norm(text)

    categories_to_scan = [category] if category and category in KEYWORD_DICT else list(KEYWORD_DICT.keys())

    selected_features: list = []
    seen = set()
    for cat in categories_to_scan:
        feature_map = KEYWORD_DICT.get(cat, {})
        for feature_name, expr in feature_map.items():
            positives = expr.get("positive", [])
            negatives = expr.get("negative", [])

            def contains_any(phrases: list) -> bool:
                for p in phrases:
                    if p and (p in text or norm(p) in text_norm):
                        return True
                return False

            if contains_any(negatives):
                continue
            if contains_any(positives):
                if feature_name not in seen:
                    seen.add(feature_name)
                    selected_features.append(feature_name)

    return selected_features

## NER ê¸°ë°˜ ìœ„ì¹˜ ì¶”ì¶œì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

def extract_location(text: str) -> Optional[str]:
    """LocationServiceë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ì—­ì„ ì¸ì‹í•œë‹¤."""
    return location_service.resolve_single_location(text)

def extract_query(text: str) -> dict:
    """ê·œì¹™/ì‚¬ì „ ê¸°ë°˜ìœ¼ë¡œ ì¿¼ë¦¬ ì„±ë¶„ì„ ì¶”ì¶œí•œë‹¤."""
    t = normalize(text)
    category = classify_category_with_rules(t)
    features = extract_features_with_rules(t, category) if category else []
    location = location_service.resolve_single_location(t)
    extracted = {"category": category, "features": features, "location": location}
    try:
        print(f"[extract_query] parsed -> {extracted}")
    except Exception:
        pass
    return extracted


# ------------------ DB ì¡°íšŒ ------------------
def query_places(query: dict) -> list:
    try:
        engine = get_db_engine()
        
        # chat_endpointì—ì„œ ê²€ì¦ì„ ê±°ì³¤ìœ¼ë¯€ë¡œ categoryì™€ locationì€ í•­ìƒ ì¡´ì¬
        category = query["category"]
        location = query["location"]
        features = query.get("features") or []

        # WHERE ì ˆì„ ëª…ì‹œì ìœ¼ë¡œ êµ¬ì„±
        where_clauses = [
            "category = :category",
            "location LIKE :location"
        ]
        params = {
            "category": category,
            "location": f"%{location}%"
        }

        # SQL ì¿¼ë¦¬ ìƒì„±
        base_sql = "SELECT place_id, category, name, location, feature FROM place WHERE "
        sql_query = base_sql + " AND ".join(where_clauses)
        sql_query += " ORDER BY updated_at DESC, created_at DESC LIMIT 30"
        
        sql = text(sql_query)
        
        with engine.connect() as conn:
            rows = [dict(r._mapping) for r in conn.execute(sql, params)]

        if not rows:
            return []

        # 1) ì¤‘ë³µ ì œê±°: ë§¤ì¥ ì´ë¦„ ê¸°ì¤€(ì •ê·œí™”)ìœ¼ë¡œë§Œ ë‹¨ì¼í™”
        def normalize_name(name: str) -> str:
            if not name:
                return ""
            base = re.sub(r"\s+", "", name)
            base = re.sub(r"[^0-9A-Za-zê°€-í£]", "", base)
            return base.lower()

        name_deduped_rows = []
        seen_names = set()
        for row in rows:
            norm = normalize_name(row.get("name"))
            if not norm or norm in seen_names:
                continue
            seen_names.add(norm)
            name_deduped_rows.append(row)

        if not name_deduped_rows:
            return []

        # 2) íŠ¹ì„±(feature) ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ Pythonì—ì„œ ì¬ì •ë ¬
        def score(place):
            place_features = (place.get("feature") or "").split(",")
            place_features = [f.strip() for f in place_features if f.strip()]
            
            # ê²€ìƒ‰ì–´ì— í¬í•¨ëœ featureê°€ ë§¤ì¥ì˜ featureì— ì–¼ë§ˆë‚˜ ìˆëŠ”ì§€ ê³„ì‚°
            match_count = sum(1 for f in features if f in place_features)
            return match_count

        name_deduped_rows.sort(key=score, reverse=True)
        # ìµœëŒ€ 5ê°œê¹Œì§€ ë°˜í™˜(ì¤‘ë³µ ì œê±°ë¡œ 5ê°œ ë¯¸ë§Œì´ ë  ìˆ˜ ìˆìŒ)
        return name_deduped_rows[:5]
        
    except Exception as e:
        print(f"DB ì¡°íšŒ ì˜¤ë¥˜: {e}") # ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
        return []


# ------------------ ì‘ë‹µ ìƒì„± ------------------
def build_reply(query: dict, places: list) -> str:
    parts = []
    if query.get("location"):
        parts.append(query['location'])
    if query.get("category"):
        parts.append(query['category'])
    if query.get("features"):
        parts.append(", ".join(query["features"]))

    cond = " ".join(parts) if parts else "ìš”ì²­í•˜ì‹ "
    
    if len(places) > 0:
        return f"{cond} ì¡°ê±´ìœ¼ë¡œ {len(places)}ê³³ì„ ì°¾ì•˜ì–´ìš”"
    else:
        return f"{cond} ì¡°ê±´ì— ë§ëŠ” ë§¤ì¥ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ ë³´ì‹œê² ì–´ìš”?"
